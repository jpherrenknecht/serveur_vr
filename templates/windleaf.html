<html>
    <head>
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
        />

        <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
        <script src="https://api.windy.com/assets/map-forecast/libBoot.js"></script>
    </head>


    <script>
        function arrondi(a,n)
            {return(Math.round(a*10**n)/10**n);}
        
            function cap(x0,y0,x1,y1)
                {capi=90-(Math.atan((y1-y0)/(x1-x0+0.0000001))*180/3.1416);
                    if ((x1-x0)>0)
                        {capi=capi+180}
                return capi }   
    // Fonction zezo                
        function crsdist(lat1, lon1, lat2, lon2) {
		var a = crsdist_num(lat1, lon1, lat2, lon2);
		   var dist = Math.round(a[1] * 34377.4)/10;
        if (dist.toString().indexOf('.') < 0) {
                dist += '.0';
        }
        var dir = Math.round(a[0] * (180/Math.PI) * 10)/10;
        if (dir.toString().indexOf('.') < 0) {
                dir += '.0';
        }
        dir = dir.toString();
        dist = dist.toString();
                while (dir.length < 5) {
                dir = " " + dir;
        }
        while (dist.length < 6) {
                dist = " " + dist;
        }
        //var res = dist + 'nm ' + dir + '°';
        var res = 'Cap :'+dir +'° Distance :'+dist+'M';
        return res;
            }
        
            function crsdist_num(lat1, lon1, lat2, lon2)
{
        lat1 = lat1 * Math.PI/180;
        lon1 = lon1 * Math.PI/180;
        lat2 = lat2 * Math.PI/180;
        lon2 = lon2 * Math.PI/180;
        var crs;        
        var d=Math.acos(Math.sin(lat1)*Math.sin(lat2)+Math.cos(lat1)*Math.cos(lat2)*Math.cos(lon1-lon2));
        var argacos=(Math.sin(lat2)-Math.sin(lat1)*Math.cos(d))/(Math.sin(d)*Math.cos(lat1));
        if (Math.sin(lon2-lon1) > 0){   
                crs=Math.acos(argacos); 
        } else {
                crs=2*Math.PI-Math.acos(argacos); 
        }
		return [crs,d];
}

        // pour formater les dates
            var intl=new Intl.DateTimeFormat("en-US",{month:"2-digit",day:"2-digit", hour12: false,hour:"2-digit", minute:"2-digit" });
         // on recupere les donnees postées
            latdep        = - {{ latdep }}
            lngdep        = {{ lngdep }}
            latar         = - {{  latar }}
            lngar         = {{  lngar }}
            
            polylinered   = {{  multipolyred }}
            polylineblack = {{  multipolyblack }}
            polylineblue  = {{  route }}
            comment       = {{  comment }}
         
            var tooltip = new Array();
            
            for ( var i=0 ; i<comment.length ; i++ )
            {
            tooltip[i]='<b>'+intl.format(1000*comment[i][2])+' - Isochrone  '+ i +' <br> Lat : '+arrondi(comment[i][0],4) +'° - Lng : ' +arrondi(comment[i][1],4)+'°<br> TWS : ' +arrondi(comment[i][3],2)
                +' Noeuds  -  TWD : ' +arrondi(comment[i][4],0)+'° <br>  Cap ' +arrondi(comment[i][5],1)+'°     -  TWA ' +arrondi(comment[i][6],1)+'° <br> Vitesse :  ' +arrondi(comment[i][7],2)+' Noeuds'}    
            
             // centrage de la carte 
             var latmap=(latdep+latar)/2;           
            var lngmap=(lngdep+lngar)/2;

            dist=((latdep-latar)**2+(lngdep-lngar)**2)**.5;
            console.log(dist);
            if(dist<5)
                {zoom=7}
            else if (dist<10)
                {zoom=6}
            else if (dist<20)
                {zoom=5}  
            else if (dist<70)
                {zoom=5}  
            else {zoom=4}







        function initialize()
        {            
            
            
            document.formu.latdep.value=arrondi(latdep,4)
            document.formu.lngdep.value=arrondi(lngdep,4)
            document.formu.latar.value =arrondi( latar,4)
            document.formu.lngar.value=arrondi(lngar,4)
            //document.formu.test.value=dist


        }
   

        const options = {
        key: 'ydO74Xuxv2WWOEShDpel1kaiae8zCnLO',
        verbose: true,

        // Optional: Initial state of the map
        lat: (latdep+latar)/2,
        lon: (lngdep+lngar)/2,
        zoom: 10,
        };

    // Initialize Windy API
        windyInit(options, windyAPI => {
        // windyAPI is ready, and contain 'map', 'store',
        // 'picker' and other usefull stuff
        const { map } = windyAPI;
        const { store } = windyAPI;
        const { picker } = windyAPI;
       
   
        
       
    // Ajout des isochrones et de la route
            L.polyline(polylineblack).setStyle({
            color: 'black',
            weight:1,
            opacity:0.3,
            }).addTo(map);

            L.polyline(polylinered).setStyle({
            color: 'red',
            weight:1,
            opacity:0.3,

            }).addTo(map);

            L.polyline(polylineblue).setStyle({
            color: 'blue',
            weight:2,
            }).addTo(map);


    // classes pour les icones
            var LeafletIcon=L.Icon.extend({
            options:{
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            shadowSize: [41, 41],
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34] 
                    }
            });

            var greenIcon = new LeafletIcon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png'});
            var blackIcon = new LeafletIcon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png'});    
            var redIcon   = new LeafletIcon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png'});   

    // marqueurs depart et arrivee        
        L.marker([latdep, lngdep],  {icon: blackIcon}).addTo(map);
        L.marker([latar, lngar],    {icon: redIcon}).addTo(map);
            
        /*/ Ajout de Marker
                var depart = L.marker([latdep,lngdep], {
                    icon: blackIcon,
                    title: "Depart"
                }).addTo(map);
        depart.bindPopup("<b>Depart</b><br> Latitude : " + latdep + '<br>Longitude : ' +lngdep).openPopup();
        */

    //marqueur echelle ne fonctionne pas    
        L.marker([45, -0.09], {icon: greenIcon}).addTo(map);
        L.control.scale({
        metric:true,
        imperial:false,
        position:'topleft'
        }).addTo(map) 

    /* ajout d'une ligne depart arrivee pour test
    ligne=[[latdep,lngdep],[latar,lngar]]
        L.polyline(ligne).setStyle({
            color: 'red',
            weight:2,
            opacity:0.3,
            }).addTo(map);
    */        
       
    // points au differents points de passage
    
    for ( var i=0 ; i<polylineblue.length ; i++ )
       { var circle = L.circle(polylineblue[i], {
                color: 'black',
                fillColor: '#f03',
                opacity:0.9,
                fillOpacity: 0.3,
                radius: 200,
            }).bindTooltip(tooltip[i]).addTo(map);
       }    
 
     
    //L.marker([49.16, -4.54], {icon: redIcon}).addTo(map);
    //L.marker([latdep,lngdep]).addTo(map)

    

    // function onMapClick(e){
    //     popup
    //     .setLatLng(e.latlng)
    //     .setContent("Les coordonnées du point sont :<br> " +e.latlng.toString())
    //     .openOn(map);
    
    // //alert("You clicked the map at " + e.latlng);
    //     }

    //     map.on('click',onMapClick)




    var popup = L.popup();
    var poly
    poly= new L.Polyline ([[0,0],[1,1]]).setStyle({color:'red',weight:1,});

 
    map.on('click', function(e) {
        latclick=e.latlng.lat
        lngclick=e.latlng.lng
        cap_dist=crsdist( latdep ,lngdep,latclick, lngclick);
    popup
        .setLatLng(e.latlng)
        .setContent("Latitude      : " +arrondi(e.latlng.lat,4) +" <br> Longitude : " +arrondi(e.latlng.lng,4) +'<br> ' +cap_dist )
        .openOn(map);
        
        document.formu.test2.value=arrondi(latclick,4);
        document.formu.test.value=arrondi(lngclick,4);
        document.formu.cap.value =arrondi(cap(lngclick,latclick,lngdep,latdep),2);
        document.formu.test3.value =crsdist( latdep ,lngdep,latclick, lngclick);
     
        map.removeLayer(poly);
        ligne=[[latdep,lngdep],[latclick,lngclick]]
        poly=new L.polyline(ligne).setStyle({
            color: 'red',
            weight:2,
            opacity:0.5,
            }).addTo(map);


    // alert("Latitude : " + e.latlng.lat + " Longitude : " + e.latlng.lng)
        });




});


    // function onMapClick(e){
    //         popup
    //         .setLatLng(e.latlng)
    //         .setContent("Les coordonnées du point sont :<br> " +e.latlng.toString())
    //         .openOn(map);
        
    //     //alert("You clicked the map at " + e.latlng);
    //         }

    //     map.on('click',onMapClick)
        </script>


       
        <style>
            #windy {  width: 100%; height: 90%;            }
            #sur { z-index: 1;  margin: 0px;   background: white;  opacity=0.1;}
        </style>
    </head>
  
    

 
    <body onload="initialize()">
        <div text-align='right' id='sur' >
            <form action="http://localhost:8080/windleaf" method="get" name='formu'>

               <label><b>Depart</b></label> Latitude</label> :
                            <input type="text" name="latdep"  value = "" />
                <label>Longitude</label> :
                            <input type="text" name="lngdep"  value="" />
                            <br>

                <label><b>Arrivee</b></label> Latitude</label> : 
                            <input type="text" name="latar" />
                <label>Longitude</label> : 
                            <input type="text" name="lngar" />             
                            <input type="submit" value="Ok" />

                  Latitude :   <input type="text" name="test" /> 
                  Longitude : <input type="text" name="test2" />
                  Cap     : <input type="text" name="cap" />


                  Test :<input type="text" name="test3" />

            </form>
        </div>

        <div id="windy">
        </div>


        
    </body>
</html>